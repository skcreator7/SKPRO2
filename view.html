<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
    <title>Stream Movie - SK4FiLM</title>
    <meta name="description" content="Stream movies in HD quality">
    <meta name="google-adsense-account" content="ca-pub-5244164301170945">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5244164301170945" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Josefin+Sans:wght@300;400;600;700&family=Montserrat:wght@800&display=swap" rel="stylesheet">
    <!-- Video.js CSS -->
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #ff0000;
            --secondary-color: #0066ff;
            --accent-color: #00ccff;
            --bg-dark: #0a0a0f;
            --card-bg: rgba(30, 41, 59, 0.9);
        }
        body {
            font-family: 'Josefin Sans', sans-serif;
            background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 100%);
            color: #f8f9fa;
            min-height: 100vh;
            padding-top: 80px;
        }
        /* Navbar */
        .navbar {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(15px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .navbar-brand {
            font-family: 'Montserrat', sans-serif;
            font-weight: 800;
            font-size: 1.5rem;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .logo-img {
            height: 40px;
            width: 40px;
            border-radius: 8px;
        }
        .btn-back-home {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            border: none;
            padding: 8px 20px;
            font-weight: 600;
            border-radius: 20px;
            color: white;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        .btn-back-home:hover {
            transform: scale(1.05);
        }
        
        /* Main Content */
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Video Player Container */
        .video-player-container {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        
        /* Video.js Custom Styles */
        .video-js {
            width: 100%;
            height: 500px;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .vjs-big-play-button {
            background: var(--primary-color);
            border: 3px solid white;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            line-height: 80px;
            font-size: 40px;
        }
        
        .vjs-control-bar {
            background: rgba(0, 0, 0, 0.8);
        }
        
        .vjs-play-progress {
            background: var(--primary-color);
        }
        
        /* Movie Info */
        .movie-info {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        
        .movie-title {
            color: var(--accent-color);
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }
        
        .movie-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 1.5rem;
        }
        
        .meta-item {
            background: rgba(0, 204, 255, 0.1);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .meta-item i {
            color: var(--accent-color);
        }
        
        /* Download Section */
        .download-section {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        
        .section-title {
            color: var(--accent-color);
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title i {
            font-size: 1.2rem;
        }
        
        /* Quality Buttons */
        .quality-buttons-row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 1.5rem;
        }
        
        .quality-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 120px;
            text-align: center;
            cursor: pointer;
        }
        
        .quality-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        
        .quality-btn.active {
            background: linear-gradient(135deg, #ff0000 0%, #ff6b6b 100%);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 0, 0, 0.4);
        }
        
        .quality-btn.disabled {
            background: #495057;
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .quality-btn.disabled:hover {
            transform: none;
            box-shadow: none;
        }
        
        /* Download Options */
        .download-options {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .download-btn {
            background: linear-gradient(45deg, #28a745, #20c997);
            border: none;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 200px;
            text-align: center;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .download-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
        }
        
        .download-btn.telegram {
            background: linear-gradient(45deg, #0088cc, #00aced);
        }
        
        .download-btn.telegram:hover {
            box-shadow: 0 8px 25px rgba(0, 136, 204, 0.4);
        }
        
        .download-btn.direct {
            background: linear-gradient(45deg, #ff8c00, #ffa500);
        }
        
        .download-btn.direct:hover {
            box-shadow: 0 8px 25px rgba(255, 140, 0, 0.4);
        }
        
        /* Loading States */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 500px;
            background: var(--card-bg);
            border-radius: 10px;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255,255,255,0.1);
            border-top: 5px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Error States */
        .error-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 500px;
            background: var(--card-bg);
            border-radius: 10px;
            padding: 40px;
            text-align: center;
        }
        
        .error-icon {
            font-size: 4rem;
            color: #ff4757;
            margin-bottom: 20px;
        }
        
        .retry-btn {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            color: white;
            font-weight: 600;
            margin-top: 20px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .retry-btn:hover {
            transform: scale(1.05);
        }
        
        /* Ad Container */
        .ad-container {
            margin: 2rem 0;
            text-align: center;
        }
        
        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .video-js {
                height: 300px;
            }
            
            .download-btn {
                min-width: 100%;
                padding: 12px 15px;
                font-size: 0.9rem;
            }
            
            .quality-btn {
                min-width: 100px;
                padding: 10px 15px;
                font-size: 0.9rem;
            }
            
            .movie-title {
                font-size: 1.4rem;
            }
        }
        
        @media (max-width: 576px) {
            .video-js {
                height: 250px;
            }
            
            .download-options {
                flex-direction: column;
            }
            
            .quality-buttons-row {
                gap: 8px;
            }
            
            .quality-btn {
                min-width: 80px;
                padding: 8px 12px;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
<!-- Navbar -->
<nav class="navbar fixed-top">
    <div class="container d-flex align-items-center justify-content-between">
        <a href="index.html" class="navbar-brand">
            <img src="https://iili.io/KOlfc41.png" alt="SK4FiLM Logo" class="logo-img">
            SK4FiLM
        </a>
        <button class="btn-back-home" onclick="window.location.href='search.html'">
            <i class="fas fa-arrow-left me-2"></i>Back to Search
        </button>
    </div>
</nav>

<!-- Main Content -->
<div class="container main-content">
    <!-- Top Ad -->
    <div class="ad-container">
        <script type="text/javascript">
            atOptions = {
                'key' : '567936a964b0784aedd11f237d26bee0',
                'format' : 'iframe',
                'height' : 250,
                'width' : 300,
                'params' : {}
            };
        </script>
        <script type="text/javascript" src="//marksdespitelinear.com/567936a964b0784aedd11f237d26bee0/invoke.js"></script>
    </div>

    <!-- Video Player Container -->
    <div class="video-player-container">
        <div id="videoLoading" class="loading-container">
            <div class="loading-spinner"></div>
            <p>Loading video player...</p>
        </div>
        
        <div id="videoError" class="error-container" style="display: none;">
            <i class="fas fa-exclamation-triangle error-icon"></i>
            <h4>Video Loading Error</h4>
            <p id="errorMessage">Unable to load the video stream.</p>
            <button class="retry-btn" onclick="loadVideoStream()">
                <i class="fas fa-redo me-2"></i>Retry Loading
            </button>
        </div>
        
        <video id="moviePlayer" class="video-js vjs-default-skin" controls preload="auto" style="display: none;">
            <p class="vjs-no-js">
                To view this video please enable JavaScript, and consider upgrading to a
                web browser that <a href="https://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a>
            </p>
        </video>
    </div>

    <!-- Movie Information -->
    <div class="movie-info">
        <h1 class="movie-title" id="movieTitle">Loading...</h1>
        
        <div class="movie-meta">
            <div class="meta-item">
                <i class="fas fa-film"></i>
                <span id="movieQuality">HD</span>
            </div>
            <div class="meta-item">
                <i class="fas fa-hdd"></i>
                <span id="movieSize">0 MB</span>
            </div>
            <div class="meta-item">
                <i class="fas fa-clock"></i>
                <span id="movieDuration">0 min</span>
            </div>
            <div class="meta-item">
                <i class="fas fa-calendar"></i>
                <span id="movieYear">2024</span>
            </div>
        </div>
        
        <div id="movieDescription">
            <p>Loading movie information...</p>
        </div>
    </div>

    <!-- Download Section -->
    <div class="download-section">
        <h3 class="section-title">
            <i class="fas fa-download"></i>Download Options
        </h3>
        
        <!-- Quality Selection -->
        <div class="quality-selection">
            <h4 class="section-title" style="font-size: 1.1rem;">
                <i class="fas fa-tv"></i>Select Quality
            </h4>
            <div class="quality-buttons-row" id="qualityButtons">
                <!-- Quality buttons will be added here -->
            </div>
        </div>
        
        <!-- Download Buttons -->
        <div class="download-options">
            <button class="download-btn telegram" id="telegramDownload" onclick="openTelegramDownload()">
                <i class="fab fa-telegram"></i>Download via Telegram Bot
            </button>
            <button class="download-btn direct" id="directDownload" onclick="openDirectDownload()">
                <i class="fas fa-download"></i>Direct Download
            </button>
        </div>
    </div>

    <!-- Bottom Ad Container -->
    <div class="ad-container">
        <script async="async" data-cfasync="false" src="//marksdespitelinear.com/5573755ef934011c90bfd5fd2a87ab2a/invoke.js"></script>
        <div id="container-5573755ef934011c90bfd5fd2a87ab2a"></div>
    </div>
</div>

<!-- Video.js Script -->
<script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
<!-- Video.js HLS Plugin -->
<script src="https://cdn.jsdelivr.net/npm/videojs-contrib-hls@5.15.0/dist/videojs-contrib-hls.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ‚úÖ Configuration
const API_ENDPOINTS = [
    'https://sk4film.koyeb.app',
    'https://sk4film-backup.herokuapp.com',
    'https://sk4film-alternate.onrender.com'
];

const AD_LINK = 'https://otieu.com/4/10220520';
const BOT_USERNAME = 'sk4filmbot';

// Get URL parameters
const urlParams = new URLSearchParams(window.location.search);
const fileId = urlParams.get('file_id');
const movieTitle = decodeURIComponent(urlParams.get('title') || '');
const quality = urlParams.get('quality') || 'HD';

// Video.js player instance
let player = null;
let currentFileInfo = null;
let availableQualities = [];

// DOM Elements
const videoLoading = document.getElementById('videoLoading');
const videoError = document.getElementById('videoError');
const errorMessage = document.getElementById('errorMessage');
const moviePlayer = document.getElementById('moviePlayer');
const movieTitleEl = document.getElementById('movieTitle');
const movieQualityEl = document.getElementById('movieQuality');
const movieSizeEl = document.getElementById('movieSize');
const movieDurationEl = document.getElementById('movieDuration');
const movieYearEl = document.getElementById('movieYear');
const movieDescription = document.getElementById('movieDescription');
const qualityButtons = document.getElementById('qualityButtons');
const telegramDownloadBtn = document.getElementById('telegramDownload');
const directDownloadBtn = document.getElementById('directDownload');

// Initialize the page
document.addEventListener('DOMContentLoaded', async () => {
    console.log('üé¨ View Page Loaded');
    console.log('üìÅ File ID:', fileId);
    console.log('üé• Title:', movieTitle);
    console.log('üìä Quality:', quality);
    
    if (!fileId) {
        showError('No file ID provided. Please go back and select a movie.');
        return;
    }
    
    // Set initial title
    movieTitleEl.textContent = movieTitle || 'Movie Player';
    
    // Load movie information
    await loadMovieInfo();
    
    // Initialize video player
    initializeVideoPlayer();
});

async function loadMovieInfo() {
    try {
        console.log('üîç Loading movie information...');
        
        // Try multiple API endpoints
        for (const endpoint of API_ENDPOINTS) {
            try {
                const response = await fetch(`${endpoint}/api/stream/info/${fileId}`);
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        currentFileInfo = data;
                        updateMovieInfo(data);
                        return;
                    }
                }
            } catch (error) {
                console.log(`‚ùå Endpoint ${endpoint} failed:`, error.message);
                continue;
            }
        }
        
        throw new Error('Could not load movie information from any endpoint');
        
    } catch (error) {
        console.error('‚ùå Error loading movie info:', error);
        showError('Failed to load movie information. Please try again.');
        
        // Set default values
        movieQualityEl.textContent = quality;
        movieSizeEl.textContent = 'Unknown';
        movieDurationEl.textContent = 'Unknown';
        movieYearEl.textContent = 'Unknown';
        movieDescription.innerHTML = '<p>Movie information could not be loaded.</p>';
    }
}

function updateMovieInfo(data) {
    console.log('üìä Updating movie info:', data);
    
    // Update title if available
    if (data.title) {
        movieTitleEl.textContent = data.title;
        document.title = `${data.title} - SK4FiLM`;
    }
    
    // Update quality
    movieQualityEl.textContent = data.quality || quality;
    
    // Update size
    movieSizeEl.textContent = data.size_formatted || formatSize(data.file_size || 0);
    
    // Update duration
    if (data.duration && data.duration > 0) {
        const hours = Math.floor(data.duration / 3600);
        const minutes = Math.floor((data.duration % 3600) / 60);
        
        if (hours > 0) {
            movieDurationEl.textContent = `${hours}h ${minutes}m`;
        } else {
            movieDurationEl.textContent = `${minutes}m`;
        }
    }
    
    // Update year if available
    if (data.year) {
        movieYearEl.textContent = data.year;
    }
    
    // Update description
    movieDescription.innerHTML = `
        <p><strong>File Name:</strong> ${data.file_name || 'video.mp4'}</p>
        <p><strong>Quality:</strong> ${data.quality || 'HD'}</p>
        <p><strong>Size:</strong> ${data.size_formatted || formatSize(data.file_size || 0)}</p>
        ${data.duration ? `<p><strong>Duration:</strong> ${formatDuration(data.duration)}</p>` : ''}
        ${data.thumbnail_url ? `<p><strong>Thumbnail Available:</strong> Yes</p>` : ''}
    `;
    
    // Check streaming availability
    if (data.streaming_enabled && data.stream_url) {
        console.log('‚úÖ Streaming available');
        document.getElementById('videoLoading').style.display = 'none';
        loadVideoStream(data.stream_url);
    } else {
        console.log('‚ùå Streaming not available');
        showError('Streaming is not available for this file. Please use download options.');
        directDownloadBtn.disabled = false;
    }
    
    // Generate quality buttons
    generateQualityButtons(data);
}

function initializeVideoPlayer() {
    try {
        player = videojs('moviePlayer', {
            controls: true,
            autoplay: false,
            preload: 'auto',
            fluid: true,
            responsive: true,
            playbackRates: [0.5, 1, 1.5, 2],
            controlBar: {
                children: [
                    'playToggle',
                    'volumePanel',
                    'currentTimeDisplay',
                    'timeDivider',
                    'durationDisplay',
                    'progressControl',
                    'liveDisplay',
                    'remainingTimeDisplay',
                    'customControlSpacer',
                    'playbackRateMenuButton',
                    'chaptersButton',
                    'descriptionsButton',
                    'subsCapsButton',
                    'audioTrackButton',
                    'fullscreenToggle'
                ]
            }
        });
        
        // Handle player errors
        player.on('error', function() {
            const error = player.error();
            console.error('Video.js Error:', error);
            
            if (error && error.code === 4) {
                showError('Video format not supported. Please try downloading instead.');
            } else {
                showError('Video playback error. Please try again or use download options.');
            }
        });
        
        // Handle player ready
        player.on('ready', function() {
            console.log('‚úÖ Video.js player ready');
        });
        
    } catch (error) {
        console.error('‚ùå Video.js initialization error:', error);
        showError('Video player initialization failed. Please try downloading instead.');
    }
}

async function loadVideoStream(streamUrl = null) {
    try {
        videoLoading.style.display = 'flex';
        videoError.style.display = 'none';
        moviePlayer.style.display = 'none';
        
        // If no stream URL provided, try to get one
        if (!streamUrl) {
            if (!currentFileInfo || !currentFileInfo.streaming_enabled) {
                throw new Error('Streaming not available for this file');
            }
            
            streamUrl = currentFileInfo.stream_url;
            
            if (!streamUrl) {
                // Try to get stream URL from API
                for (const endpoint of API_ENDPOINTS) {
                    try {
                        const response = await fetch(`${endpoint}/api/stream/url/${fileId}`);
                        if (response.ok) {
                            const data = await response.json();
                            if (data.status === 'success' && data.stream_url) {
                                streamUrl = data.stream_url;
                                break;
                            }
                        }
                    } catch (error) {
                        console.log(`‚ùå Stream URL from ${endpoint} failed:`, error.message);
                        continue;
                    }
                }
            }
        }
        
        if (!streamUrl) {
            throw new Error('Could not get streaming URL');
        }
        
        console.log('üé¨ Loading stream URL:', streamUrl);
        
        // Set video source
        player.src({
            src: streamUrl,
            type: 'application/x-mpegURL' // HLS stream
        });
        
        // Load and play
        player.load();
        player.play();
        
        // Show player
        videoLoading.style.display = 'none';
        moviePlayer.style.display = 'block';
        
        console.log('‚úÖ Video stream loaded successfully');
        
    } catch (error) {
        console.error('‚ùå Error loading video stream:', error);
        showError('Failed to load video stream. Please try downloading instead.');
    }
}

function generateQualityButtons(data) {
    qualityButtons.innerHTML = '';
    
    // Default quality from current file
    const currentQuality = data.quality || quality;
    
    // If we have multiple qualities in the search results
    if (data.available_qualities && Array.isArray(data.available_qualities) && data.available_qualities.length > 1) {
        availableQualities = data.available_qualities;
        
        availableQualities.forEach(q => {
            const button = document.createElement('button');
            button.className = `quality-btn ${q === currentQuality ? 'active' : ''}`;
            button.textContent = q;
            button.onclick = () => switchQuality(q);
            qualityButtons.appendChild(button);
        });
    } else {
        // Single quality button
        const button = document.createElement('button');
        button.className = 'quality-btn active';
        button.textContent = currentQuality;
        button.disabled = true;
        qualityButtons.appendChild(button);
    }
}

async function switchQuality(newQuality) {
    console.log('üîÑ Switching to quality:', newQuality);
    
    // Update active button
    document.querySelectorAll('.quality-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent === newQuality) {
            btn.classList.add('active');
        }
    });
    
    // Update quality display
    movieQualityEl.textContent = newQuality;
    
    // Try to get new stream URL for this quality
    try {
        for (const endpoint of API_ENDPOINTS) {
            try {
                const response = await fetch(`${endpoint}/api/stream/url/${fileId}?quality=${encodeURIComponent(newQuality)}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'success' && data.stream_url) {
                        // Reload stream with new quality
                        loadVideoStream(data.stream_url);
                        return;
                    }
                }
            } catch (error) {
                console.log(`‚ùå Quality switch from ${endpoint} failed:`, error.message);
                continue;
            }
        }
        
        showError('Could not switch quality. Please try the current quality or download instead.');
        
    } catch (error) {
        console.error('‚ùå Error switching quality:', error);
        showError('Failed to switch quality. Please try again.');
    }
}

function openTelegramDownload() {
    if (!currentFileInfo) {
        alert('Movie information not loaded yet. Please wait.');
        return;
    }
    
    const botUsername = currentFileInfo.bot_username || BOT_USERNAME;
    const telegramUrl = currentFileInfo.telegram_bot_url || `https://t.me/${botUsername}?start=${fileId}`;
    
    console.log('ü§ñ Opening Telegram bot:', telegramUrl);
    window.open(telegramUrl, '_blank');
}

async function openDirectDownload() {
    if (!currentFileInfo) {
        alert('Movie information not loaded yet. Please wait.');
        return;
    }
    
    try {
        // Try to get direct download URL
        for (const endpoint of API_ENDPOINTS) {
            try {
                const response = await fetch(`${endpoint}/api/download/info/${fileId}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'success' && data.download_info) {
                        const downloadInfo = data.download_info;
                        
                        // Check if we have a direct URL
                        if (downloadInfo.direct_url) {
                            window.open(downloadInfo.direct_url, '_blank');
                        } else if (downloadInfo.telegram_bot_url) {
                            window.open(downloadInfo.telegram_bot_url, '_blank');
                        } else {
                            // Fallback to Telegram bot
                            const botUsername = currentFileInfo.bot_username || BOT_USERNAME;
                            window.open(`https://t.me/${botUsername}?start=${fileId}`, '_blank');
                        }
                        return;
                    }
                }
            } catch (error) {
                console.log(`‚ùå Direct download from ${endpoint} failed:`, error.message);
                continue;
            }
        }
        
        // Fallback to Telegram bot
        const botUsername = currentFileInfo.bot_username || BOT_USERNAME;
        window.open(`https://t.me/${botUsername}?start=${fileId}`, '_blank');
        
    } catch (error) {
        console.error('‚ùå Error getting download URL:', error);
        alert('Could not get download URL. Please try the Telegram bot.');
    }
}

function showError(message) {
    errorMessage.textContent = message;
    videoLoading.style.display = 'none';
    moviePlayer.style.display = 'none';
    videoError.style.display = 'flex';
}

function formatSize(bytes) {
    if (!bytes || bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function formatDuration(seconds) {
    if (!seconds || seconds === 0) return '0m';
    
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = Math.floor(seconds % 60);
    
    if (hours > 0) {
        return `${hours}h ${minutes}m ${secs}s`;
    } else if (minutes > 0) {
        return `${minutes}m ${secs}s`;
    } else {
        return `${secs}s`;
    }
}

// Handle page visibility changes
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        // Page is hidden, pause video
        if (player && !player.paused()) {
            player.pause();
        }
    }
});

// Clean up on page unload
window.addEventListener('beforeunload', function() {
    if (player) {
        player.dispose();
    }
});

// Debug info
console.log('‚úÖ SK4FiLM View Page Loaded');
console.log('üéØ Features: Video.js Player + Quality Selection + Download Options');
console.log('üì± Open browser console (F12) for debugging');
</script>
</body>
</html>
